---
layout: post
title: JavaScript to call to external DLL by NPAPI plugin
date: '2011-04-09T06:29:00.000-07:00'
author: Jan Fajfr
tags:
- JavaScript
- C++
modified_time: '2014-06-27T02:29:38.086-07:00'
thumbnail: http://2.bp.blogspot.com/-GSf6I51qfpI/TaBW9FN3NGI/AAAAAAAAAJs/rTZrt0eBDU8/s72-c/export_symbols.PNG
blogger_id: tag:blogger.com,1999:blog-1710034134179566048.post-4506190779342821698
blogger_orig_url: http://hoonzis.blogspot.com/2011/04/javascript-to-call-to-external-dll-by.html
---

This is a somewhat special scenerio: you want to use JavaScript to call a function exposed by DLL. The DLL is old Native C++. Here in this simple Proof of Concept I call a DLL which simple writes to a file on disk.<br /><br />I have achived this by using NPAPI plugin. (I did not do it for fun, but it was one of my assignements last week...)<br /><br />Netscape Plugin API is a plugin architecture which allows you to write components (plugins) which can be embeded to web pages. Plugins are developed in native code and are deployed via registering the resulting DLL file to Windows Registry. (using regsvr32 on Windows).<br /><br /><h2>Creating the native dll library to be called</h2>In this part I will just define a simple DLL library with one function allowing you to write to file. Normally you have already some legacy dll which you want to call, this one will serve just for a test. There is a <a href="http://msdn.microsoft.com/en-us/library/ms235636(v=vs.80).aspx">MSDN page concerning this topic.</a><br /><br />In Visual Studio creat a new project -> <b>Visual C++ -> Win32 -> Win32 Console Application.</b><br /><br />You will be presented by a Application Settings dialog where you can select DLL library and Export symbols.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-GSf6I51qfpI/TaBW9FN3NGI/AAAAAAAAAJs/rTZrt0eBDU8/s1600/export_symbols.PNG" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="191" width="194" src="http://2.bp.blogspot.com/-GSf6I51qfpI/TaBW9FN3NGI/AAAAAAAAAJs/rTZrt0eBDU8/s320/export_symbols.PNG" /></a></div><br />A project structure is created for you, where a header file and corresponding cpp file named after you project will be prepared for you to define and implement functions which you want to expose. I have called my project "NativeLib". Here is the header file:<br /><pre class="prettyprint"><br />class NATIVELIB_API CNativeLib {<br />public:<br /> CNativeLib(void);<br />};<br /><br />extern NATIVELIB_API int nNativeLib;<br /><br />NATIVELIB_API int fnNativeLib(void);<br /><br />NATIVELIB_API int fnPrintToFile(void);<br /></pre><p>And here the code file:</p><pre class="prettyprint"><br />NATIVELIB_API int fnNativeLib(void)<br />{<br /> return 42;<br />}<br /><br />NATIVELIB_API int fnPrintToFile(void)<br />{<br /> ofstream myfile;<br /> myfile.open ("C:\example.txt");<br /> if(myfile.is_open()){<br />  myfile << "Writing this to a file.\n";<br />                return 1;<br /> }else{<br />            return 0;<br />        }<br /> myfile.close();<br />}<br /><br />// This is the constructor of a class that has been exported.<br />// see NativeLib.h for the class definition<br />CNativeLib::CNativeLib()<br />{<br /> return;<br />}<br /></pre>You can see that there is already one function predefined which returns the ultimate answer. I have just added my function to write a simple text to a file. When you compile the solution, you will have a dll file and also a lib file.  <h2>Creating the plugin structure</h2><p>The architecture of the plugin is quite complicated so to help out there is a tool called FireBreath which helps you with creation of the simple plugin.</p><p>Firebreath is written in C++ and uses Python to run PREP scripts so you will need Python to execute it. You can download Firebreath from its <a href="http://www.firebreath.org">official page</a> or from its GIT repository. On the official page you can find a great video works you through the process of creation of the plugin structure.</p><p>Firebreath also uses CMAKE to create a build which will fit your platform needs. CMAKE is a crossplatform build system which from one configuration written in a CMakeList.txt file will build Make file or Visual Studio Solution structure which later can be build on your system.</p> Follow the <a href="http://www.firebreath.org/display/documentation/Windows+Video+Tutorial">video on the Firebreath page</a> to create the plugin structure and the VS solution. During the process of creation you will be asked for the name of the plugin, description, if you want your plugin to have GUI and some additional information.  If you open created Visual Studio solution you will see that it consists of several projects, but you will be concerned only with the with the same name as you gave to your plugin. <div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-6qA7j0NH4dI/TaAwbCIuArI/AAAAAAAAAJc/bx4AUeTCfxo/s1600/project_structure.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="320" width="135" src="http://1.bp.blogspot.com/-6qA7j0NH4dI/TaAwbCIuArI/AAAAAAAAAJc/bx4AUeTCfxo/s320/project_structure.png" /></a></div>If you opened the details of the project you will see that it contains a header file with "API" suffix and corresponding cpp file. <div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-hHro78SMPqo/TaAw6R4wzZI/AAAAAAAAAJk/PFCbvdRpgg8/s1600/project_structure2.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="320" width="126" src="http://4.bp.blogspot.com/-hHro78SMPqo/TaAw6R4wzZI/AAAAAAAAAJk/PFCbvdRpgg8/s320/project_structure2.png" /></a></div>Now to add your function to the API file you will add it respectively to header and to cpp file:  <pre class="prettyprint"><br />class MyAPI : public FB::JSAPIAuto<br />{<br />public:<br />    MyAPI(const OctoTestPtr& plugin, const FB::BrowserHostPtr& host);<br />    virtual ~MyAPI();<br /><br />    MyPtr getPlugin();<br />   <br />   //call to native library to print to file<br />   int printToFile();<br />};<br /></pre><pre class="prettyprint"><br />//add the header file<br />#include "NativeLib.h"<br /><br />//add the function implementation<br />int MyAPI::printToFile()<br />{<br /> return fnPrintToFile();<br />}<br /></pre><p>There is one last step and that is to register this method so it will be exposed by the plugin to JavaScript calls. This is done in the constructor of the plugin:</p><pre class="prettyprint"><br />MyAPI::MyAPI(const MyPtr& plugin, const FB::BrowserHostPtr& host) : m_plugin(plugin), m_host(host)<br />{<br />  registerMethod("printToFile", make_method(this,&MyAPI::printToFile));<br />}<br /></pre><p>Now you will have to add the header file to your solutions header files and than the LIB for the linker to be able to find your native library functions. To do so go to <b>Project properties -> Linker -> Input -> Additional Dependencies</b> and add your lib file here. One last will be to copy the NativeLib.dll to the location of you plugins generated DLL.</p><p>Now you can compile the solution (first time it will take maybe couple minutes, next time it will be faster since you are only changing one project). In the "BIN\Debug" folder you will find the DLL of your plugin. Now run regsvr32 myplugin.dll and the plugin should be registered.</p> <p>Now you can locate FBControl.html (generated for you by Firebreath) which already contains your plugin so you can test it directly (you should find it in "projects\MyPluging\gen" folder). Now that file already contains a JavaScript function to get your plugin.</p><pre class="prettyprint"><br />function plugin0()<br />{<br />   return document.getElementById('plugin0');<br />}<br />plugin = plugin0;<br /></pre><p>So in the body of the html just add a button to call the plugins function by JavaScript and show the result of the function:</p><pre class="prettyprint"><br />&lt;input type="button" value="Print to file" name="button2" onClick="alert(plugin().printToFile());"&gt;<br /></pre>This is quite special scenario so I am not sure if this post will serve anyone...but never know.