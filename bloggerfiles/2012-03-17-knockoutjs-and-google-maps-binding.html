---
layout: post
title: KnockoutJS and Google Maps binding
date: '2012-03-17T02:59:00.008-07:00'
author: Jan Fajfr
tags:
- MVVM
- JavaScript
modified_time: '2014-06-26T14:29:07.926-07:00'
thumbnail: http://lh4.ggpht.com/-HXElwVXPlV4/T2RgnYw2SeI/AAAAAAAAATY/RHL4H9fBXqw/s72-c/image_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-1710034134179566048.post-1973359973792824666
blogger_orig_url: http://hoonzis.blogspot.com/2012/03/knockoutjs-and-google-maps-binding.html
---

<p>This post describes the integration between Google Maps and KnockoutJS. Concretely you can learn how to make the maps marker part of the View and automatically change it's position any time when the ViewModel behind changes. The ViewModel obviously has to contain the latitude and longitude positions of the point that you wish to visualize on the map.</p><p>Previously I have worked a bit with Silverlight/WPF which in general leaves one mark on a person: the preference for declarative definition of the UI leveraging the rich possibilities of data binding provided by the previously mentioned platforms. In this moment I have a small free-time project where I am visualizing a collection of points on a map. This post describes how to make the marker automatically change it's position after the model values behind changes. Just like in this picture bellow, where the position changes when user changes the values of latitude and longitude in the input boxes.</p><p><a href="http://lh6.ggpht.com/-KtZ1v4DOEl4/T2RgmGXhokI/AAAAAAAAATQ/rOq7ve_0OH8/s1600-h/image%25255B2%25255D.png"><img style="background-image: none; border-right-width: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/-HXElwVXPlV4/T2RgnYw2SeI/AAAAAAAAATY/RHL4H9fBXqw/image_thumb.png?imgmax=800" width="230" height="244"></a></p><p>Since I like Model-View-ViewModel pattern I was looking for a framework to use this pattern in JS, obviously <a href="http://knockoutjs.com">KnockoutJS</a> saved me. The application that I am working on, has to visualize several markers on Google Maps. As far as I know there is no way to define the markers declaratively. You have to use JS:</p><pre class="prettyprint">marker = new google.maps.Marker({<br />  map:map,<br />  draggable:true,<br />  animation: google.maps.Animation.DROP,<br />  position: parliament<br />});<br />google.maps.event.addListener(marker, 'click', toggleBounce);</pre><p>So let's say you have a ViewModel which holds a collection of interesting points, that will be visualized on the map. You have to iterate over this collection to show all of them on the map. One possible way around would be to use the <strong>subscribe</strong> method of KO. You could subscribe for example to the latitude of the point (assuming that the latitude would be an observable) and on any change perform the JS code. There is a better way.</p><h3>Defining custom binding for Google Maps.</h3><p>The way to go here is to <a href="http://knockoutjs.com/documentation/custom-bindings.html">define a custom binding</a>, which will take care of the update of the point on the map, any time, that one of the observable properties (in basic scenario: latitude and longitude) would change.</p><pre class="prettyprint"><br />ko.bindingHandlers.map = {<br />init: function (element, valueAccessor, allBindingsAccessor, viewModel) {<br />  var position = new google.maps.LatLng(allBindingsAccessor().latitude(), allBindingsAccessor().longitude());<br />  var marker = new google.maps.Marker({<br />    map: allBindingsAccessor().map,<br />    position: position,<br />    icon: 'Icons/star.png',<br />    title: name<br />  });<br />  viewModel._mapMarker = marker;<br />},<br />update: function (element, valueAccessor, allBindingsAccessor, viewModel) {<br />  var latlng = new google.maps.LatLng(allBindingsAccessor().latitude(), allBindingsAccessor().longitude());<br />  viewModel._mapMarker.setPosition(latlng);<br /> }<br />}<br /></pre><pre class="prettyprint"><br />;&lt;div data-bind="latitude: viewModel.Lat, longitude:viewModel.Lng, map:map" &gt;&lt;/div&gt;<br /></pre><p>So let's describe what is going on here. We have defined a <strong>map</strong> binding. This binding is used on a div element. Actually the type of the element is not important. There are also <strong>latitude</strong> and <strong>longitude</strong> bindings, which are not defined. That is because the <strong>map</strong> binding takes care of everything. The binding has two functions: <strong>init</strong> and <strong>update</strong>, first one called only once, the second one called every time the observable value changes.</p><p>The <strong>allBindingsAccessor</strong> parameter contains a collection of all sibling bindings passed to the element in the <strong>data-bind</strong> attribute. the <strong>valueAccessor</strong>, holds just the concrete binding (in this case the map value, because we are in definition of the map binding). So from the <strong>allBindingsAccessor</strong> we can easily obtain the values that we need:</p><pre class="prettyprint"><br />allBindingsAccessor().latitude()<br />allBindingsAccessor().longitude()<br />allBindingsAccessor().map()<br /></pre>Notice that the <strong>map</strong> is passed to the binding in parameter (that is concretely the <strong>google.maps.Map</strong> object, not the DOM element. Once we have these values, there is nothing easier than to add the marker to the map.</p><p>And there is one important thing to do at the end – <strong>save the marker, somewhere so we can update it’s position later</strong>. Here again KO comes with rescue, because we can use the <strong>viewModel</strong> parameter passed to the binding and we can attach the marker to the ViewModel. Here I suppose that there is no existing variable with name <strong>_mapMarker</strong> in the viewModel and JS can happily add the variable to the ViewModel.</p><pre class="prettyprint"><br />viewModel._mapMarker = marker; <br /></pre>The update method has an easy job, because the marker has been stored, and we only need to update it's position.</p><pre class="prettyprint"><br />viewModel._mapMarker.setPosition(latlng);<br /></pre><h3>Almost full example</h3><a href="http://jsfiddle.net/Wt3B8/23/">Just check it here on JsFiddle</a>.<br /><h3>Possible improvements</h3><p>One thing that I do not like about this, is the fact, that you have to pass the map as an argument to the binding and the div element has to be outside of the map. Coming from Silverlight/WPF you would like to do something like this:</p><pre>&lt;div id=”map_canvas”&gt;<br />&lt;div data-bind=”latitude: vm.Lat, longitude:vm.Lng”&gt;Whatever I want to show on the map marker&lt;/div&gt;<br />&lt;/div&gt;</pre><p>That is actually the beauty of declarative UI definition. You can save a lot of code only by composing the elements in the correct order. However this is not possible – at least I was not able to get it to work. I was close however:</p><pre class="prettyprint"><br />init: function (element, valueAccessor, allBindingsAccessor, viewModel) {<br />var map = element.parentNode;<br />var googleMap = new google.maps.Map(.map.);<br />//add the pointer<br />var contentToAddToMarker = element;<br />}<br /></pre><p>Again thanks to KO, here the element variable represents the DOM element to which the binding is attached. If the div element is inside the map, than we can get the parent element (which is the div for the map) and we are able to create a new map on this element. The problem which I had is the once, the new map was created, the div elements nested inside the map disappeared. Even if that would work, some mechanism would have to be introduced, in order to create the map only the first time (in case there are more markers to show on the map) and store it somewhere (probably as global JS variable).</p><p>On the other hand, thanks to the element you can get all the div which should be for example given as the description to the marker.</p><p>Summary: <strong>KnouckoutJS</strong> <strong>is great</strong>. It lets me get rid of the bordelic JS code.</p><a style="display: none" href="http://www.codeproject.com/script/Articles/BlogFeedList.aspx?amid=honga" rel="tag">CodeProject</a>