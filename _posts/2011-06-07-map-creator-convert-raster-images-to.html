---
layout: post
title: Map Creator - convert raster images to maps data (in Silverlight)
date: '2011-06-07T15:53:00.000-07:00'
author: Jan Fajfr
tags:
- Maps
- Silverlight
modified_time: '2014-06-26T15:02:39.937-07:00'
thumbnail: http://4.bp.blogspot.com/-OWat90XDXOI/Te6rdb5WY-I/AAAAAAAAALQ/ArDO4OjD7Gw/s72-c/map_creator_view.PNG
blogger_id: tag:blogger.com,1999:blog-1710034134179566048.post-8296620690953124543
blogger_orig_url: http://hoonzis.blogspot.com/2011/06/map-creator-convert-raster-images-to.html
---

This posts talks about a tool which can help you convert lines in raster maps to a set of locations which later can be visualized using Silverlight Bing Maps (or some other mapping framework).<br /><br />I call the application <b>Silverlight Map Creator</b> :) and it is disponible at:<br /><a href="http://mapcreator.codeplex.com/">http://mapcreator.codeplex.com/</a>.<br /><br /><br />This application can help you a bit when you have an existing map in a bitmap picture format (png, jpeg) and you would like to use the route lines from this map in your application.<br /><br />Then you have two options:<br /><br /><ul><li> Use MapCruncher. MapCruncher is tool from MS which allows you to create your own Tiles source from existing map. OK, if you never heard of Tiles:<br /><br />When using a map component (Google Maps, Bing Maps or any other) the entire map is composed of several tiles, each tile, when you zoom in is again composed of "smaller tiles" (they are of the same size, but have higher precision).<br />So MapCruncher lets you create your own map, composed of you own tiles based on the raster image. Later you can use this new map and "put it over" the standard Bing/Google/Open map - thus showing the additional information.<br /><br />This however has one disadvantage - the map is quite static - it is just a bunch of pixel on top of your the classic map - you are for example not able to get the total length of the route on the map.</li><li>You need to obtain the geo-data which specify the route lines - in other words coordinations of the route points. To obtain this data from predefined image you would need to first set the correspondence between the image and the map and than analyze the image to get all the points of your map.<br />I decided to create a tool which would help me with this task - this post is a brief description of the tool.</li></ul><br />Here is a screen shot of the Map Creator tool which will help you accomplish it:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-OWat90XDXOI/Te6rdb5WY-I/AAAAAAAAALQ/ArDO4OjD7Gw/s1600/map_creator_view.PNG" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="226" width="320" src="http://4.bp.blogspot.com/-OWat90XDXOI/Te6rdb5WY-I/AAAAAAAAALQ/ArDO4OjD7Gw/s320/map_creator_view.PNG" /></a></div><br /><br />If you are wondering in the screenshot I am converting a map of a ski-race (www.jiz50.cz) to a set of points. In the left part you can see the map (jpg image) and in the right part the resulting route.<br /><br /><h3>Converting raster image to map</h3>The task of converting raster image to map data is composed of the following parts:<br /><ul><li>Load the image (by clicking the browse button...)</li><li>Set correspondence points between the image and the map</li><li>Pick up the color which defines the route or path in the raster image</li><li>Set some parameters for the analysis of the map</li><li>Press Start and hope to get some results</li><li>Perform some changes to the route</li>-> change positions of the points</li>-> remove points from route</li><li>Add the route which you have obtained to the "result" set<br />-> result set defines the data which is used to generate the XML.<br />-> also this is the data which is saved any time, that you press save</li><li>Generate XML data for your maps</li></ul>To accomplish all of that the application has a simple menu:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-O3lmZzFGSBw/Te6rvXPC68I/AAAAAAAAALY/sNLJ49jLVVs/s1600/map_creator_menu.PNG" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="140" width="320" src="http://4.bp.blogspot.com/-O3lmZzFGSBw/Te6rvXPC68I/AAAAAAAAALY/sNLJ49jLVVs/s320/map_creator_menu.PNG" /></a></div><br /><br /><br />Here are some details to the parts which are not straightforward:<br /><br /><h3>Setting correspondences</h3><br /><b>Technical background</b><br />Generally to set correspondences between two coordination systems you need to determine if there is a transformation which could transform the coordinates of one point from the resource to the resulting coordination systems.<br /><br />Map Creator is not really sophisticated tool so it supports only the case when there is a Affine Transformation between the two coordination systems.<br /><br />Affine transformation preserves colinearity, that means that points which lie on a line in one coordination system will also lie on the map in the second one. Basically it means that Affine transformation can be composed of any linear transformation (scaling, rotation) and translation, for example skewing is not allowed.<br /><br />The relation between the two coordination systems can be specified using the following equation:<br /><br />sx = c00*rx + c01*ry + c02<br />sy = c10*rx + c11*ry + c12<br /><br />(rx, ry) - coordinates in resource coordination system (so lets say pixels in the image)<br />(sx,sy) - coordinates in the resulting system (so lets say longitude and latitude)<br /><br />So we need 6 parameters. For each point we have 2 equations, so we need 3 points to have 6 equations for 6 parameters. In matrix notation we can write it like this.<br /><br />[c00 c01 c02] [x1 x2 x3]     [u1 u2 u3]<br />[c10 c11 c12] [y1 y2 y3]  =  [v1 v2 v3]<br />[ 1  1  1]     <br /><br /><b>In Map Creator</b><br />Just select the "Correspondences" radio button. Then every time you click "Right" on the image, a new point is added to a list, when you select the point and click right on the map a correspondence will be set.<br /><br /><h2>Select colors of the route</h2>Just select the "Color selection" radio button. Than when you click right button the mouse in the picture the color will be selected (and added to the list).<br /><br /><h3>Set the parameters</h3>There are 4 parameters which somehow change the why the resulting route is going to look like:<br /><b>1)Search Range</b> - basically it says what is the minimal distance in pixels of points of the same route. Setting this parameter to bigger value will cause connections between routes which are normally not connected. To low parameter will increase the density of point in the route (which is not desirable either).<br /><b>2) Color toleration</b> - determines the color of the pixel which will still be marked as in the route. Each color is composed of 3 parts (RGB) with values in range 0-255. This parameter sets the tolerance for each part (RGB).<br /><b>Min Points Per Route</b> - Each bike route is composed of several routes (or lets say lines). This is caused by side routes, which have to be represented separately. This parameter sets the minimal points for each route. If there is a route with less points that this parameter sets, it will not be added to the result.<br /><b>Distance to connect</b>After the analysis, some routes which should be connected are will not be. Typical example are the side routes. There will always be a little space between the main route and the side routes. This parameter sets what is the maximal distance between to routes which should be connected.<br /><br /><h3>Performing changes to the resulting route</h3>There are two possible changes that you can do:<br />1) Remove the point by clicking the right button<br />2) Change the position of the point by dragging it<br /><br /><h3>Adding the route the the results</h3>Generally a map is composed of several routes. The basic idea behind this tool is that once you have finished working on a route, you can add it to the result (pressing the button on the list of colors). When the route is in the results it will not be affected by running the analysis again.<br /><br /><h3>Saving your work</h3>By pressing "Save" button you can save your work. Saved will be the list of correspondences and the routes in the "result" set. This why the next time you can continue working on existing map.<br /><br /><h3>Generating XML</h3>The main idea is to use the data which you have generated in your application. The "Generate XML" button simply serializes the "result" set to XML.<br />As said before: Map is a collection of routes. Route is a collection of lines. Line is a collection of locations.<br />OK, in C# or Java or whichever language it is something like this:<br /><br /><pre class="prettyprint"><br />List&lt;List&lt;List&lt;Location&gt;&gt;&gt; result<br /></pre><br />When you serialize this object to XML (here just using the standard C# serializer you will obtain XML with following structure:<br /><pre class="prettyprint"><br />&lt;?xml version="1.0" encoding="utf-16"?&gt;<br />&lt;arrayofarrayofarrayoflocation xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;<br />  &lt;arrayofarrayoflocation&gt;<br />    &lt;arrayoflocation&gt;<br />      &lt;location&gt;<br />        &lt;latitude&gt;50.834165728659457&lt;/Latitude&gt;<br />        &lt;longitude&gt;15.292032040283674&lt;/Longitude&gt;<br />        &lt;altitude&gt;0&lt;/Altitude&gt;<br />        &lt;altitudereference&gt;Ground&lt;/AltitudeReference&gt;<br />      &lt;/Location&gt;<br />      &lt;location&gt;<br />        &lt;latitude&gt;50.83278001263735&lt;/Latitude&gt;<br />        &lt;longitude&gt;15.293082116316537&lt;/Longitude&gt;<br />        &lt;altitude&gt;0&lt;/Altitude&gt;<br />        &lt;altitudereference&gt;Ground&lt;/AltitudeReference&gt;<br />      &lt;/Location&gt;<br />&lt;/ArrayOfLocation&gt;<br />&lt;/ArrayOfArrayOfLocation&gt;<br />&lt;/ArrayOfArrayOfArrayOfLocation&gt;<br /></pre><br />OK, I agree - it is too verbose and not optimized and for most ugly, but I did not have time to implement my own format.<br /><br /><h3>Future</h3>So that's it. I am not sure that this tool will be useful to anyone, if you think that you might use it, if you have a suggestion or a bug, just leave me a note here...(ok not for the bugs, there is too many of them anyway).