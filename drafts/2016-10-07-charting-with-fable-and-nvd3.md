---
layout: post
title: Options and Stocks charts in F# and JavaScript
date: '2016-04-16T05:25:00.000-08:00'
author: Jan Fajfr
tags:
- Maps
modified_time: '2016-04-16T05:11:43.965-08:00'
---
Recently I came across [Fable](http://fable.io/). Fable transpiles F# code into JavaScript, so you can run your F# in the browser. It will also generate map files, so that you can even debug F# in the browser and the generated JS is actually very readable so if something goes wrong you can still look to the "compiled" code. To sum it up, it's really a great project and I was amazed on how few modifications were necessary to my code to make it compile into JS. I am working on a small application to visualize some financial data and I figured out it would be great to use Fable for this. So I set myself to make Fable work with NVD3 and draw some interesting charts.

### Installing Fable
Fable is a compiler, so you might expect an executable. In this case it comes bundled as **npm** package, which you might want to install globally:

npm install -g fable-compiler

### Setup the Fable project
Before you get started with any code, you have to consider few things:

* Are you going to fit everything into single F# file or you will create a project? Fable allows you to do both and in the simpliest situation I will just point fable to a single file, but if you plan to build something bigger, you better create F# project (F# library will work, even though you won't distribute anything as library but compile into JS instead).

* How the resulting JavaScript should be structured and packaged? Two most common ways of defining modules in JavaScript are AMD and CommonJS.

* How is the resulting JS bundled. Fable will create one JavaScript file per F# file, these files have to be then loaded by the browser. Depending on the module pattern (CommonJS vs AMD) you will have to bundle them together to a single JavaScript file which will be included in the html.

I have chosen the following setup: F# project with multiple files. CommonJS as module system, bundled with Webpack. To go for this configuration, you will have to create the following 3 files in the root of the project folder:

**package.json**  - will define your JavaScript project (standard Node project), here you can list the necessary packages that you depend on.

**fableconfig.json** - Fable's configuration - tell fable what are his dependencies, which JavaScript module system should be used.

**webpack.config.json** - Webpack's config, tell him where the JS files are (generated by fable) and where to output the bundled result

### Creating the web page
The page itself will be very small - it contains only one div tag which we will use to draw the chart. We also have to reference all JavaScript libraries on which we are depending and finally the JavaScript compiled from our F# code.

### The F# application
Let's look at the content of "main" file. The file contains a single module, with a single function that is invoked. This function will be called when the JavaScript is loaded.

```ocaml
namespace Pricer.Fabled

open System

module ChartingTest =

    let random = new Random()

    let randomValues() =
        [|1 .. 10|] |> Array.map (fun i ->
        {
            x = new DateTime(2014, i, 1)
            y = float (random.Next() / 100000)
            size = float (random.Next())
        })

    let drawChart() =
        let series = [|
                {
                    key = "Series 1"
                    values = randomValues()
                };
                {
                    key = "Series 2"
                    values = randomValues()
                }
            |]

        Charting.drawScatter series "#chart"

    drawChart()
```

All we are doing here is preparing the data for the charting. We will generate an array of items for the scatter chart. Each item has three properties (x,y,size). Then we will wrap all the data into two series and pass to the drawing function. Note that nothing is said here about the types of the values, but the standard NVD3 JavaScript code would look very similar. You can look at the [official scatter chart example](https://github.com/nvd3-community/nvd3/blob/gh-pages/examples/scatterChart.html). We will look into the details of **drawScatter** method later.

### Writing typed definitions for NVD3
In the previous snippet we have created an array of "Series" with two Series of random data. The shape of the series reflects what NVD3 is expecting, but since we are compiling from F# we have to define the types that would resemble to what NVD3 is expecting. That is really not that hard, these 2 records will do:

```ocaml
type DateScatterValue = {
    x: DateTime
    y: float
    size: float
}

type Series<'a> = {
    key: string
    values: 'a array
}
```

### Drawing the charts
Our drawing function takes two parameters. First the data to draw and a selector which will tell us to which element in the HTML page we should draw the chart. The content will again resemble a lot a JavaScript NVD3 [official scatter chart example](https://github.com/nvd3-community/nvd3/blob/gh-pages/examples/scatterChart.html).

```ocaml
let drawScatter (data: Series<DateScatterValue> array) (chartSelector:string) =
    let colors = D3.Scale.Globals.category10()
    let chart = nv.models.scatterChart().pointRange([|10.0;800.0|]).showLegend(true).showXAxis(true).color(colors.range())
    let timeFormat = D3.Time.Globals.format("%x")
    chart.yAxis.axisLabel("Strike") |> ignore
    chart.xAxis.tickFormat(fun x ->
        let dateValue = DateUtils.fromTicks(x :?> int)
        timeFormat.Invoke(dateValue)
    ).axisLabel("Expiry") |> ignore
    let chartElement = D3.Globals.select(selector);
    chartElement.html("") |> ignore
    chartElement.style("height","500px") |> ignore
    chartElement.datum(data).call(chart) |> ignore
```

This function calls two libraries: NVD3 and D3 itself. There is however a small diference. For any NVD3 code that we call, we have to define the F# types, so that F# compiler is not confused, and Fable "knows" that it can just output the code itself.
